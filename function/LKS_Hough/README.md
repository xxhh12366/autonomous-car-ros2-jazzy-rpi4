# LKS - 车道保持系统 (Lane Keeping System)

## 功能概述

车道保持系统使用霍夫变换算法检测车道线，实时计算车辆偏离量，并通过舵机控制实现车道居中行驶。

## 技术原理

### 图像处理流程

1. **灰度转换**: 将彩色图像转换为灰度图，简化后续处理
2. **高斯滤波**: 使用3x3高斯核去除图像噪声
3. **Canny边缘检测**: 检测图像中的边缘特征
4. **感兴趣区域(ROI)**: 设置梯形区域，只处理车道线可能出现的区域
5. **霍夫变换**: 检测直线段，识别车道线
6. **角度滤波**: 过滤掉角度不合理的直线（保留20-80度的直线）
7. **车道线拟合**: 分别拟合左右车道线
8. **误差计算**: 计算车辆中心与车道中心的偏差
9. **舵机控制**: 根据偏差值调整舵机角度

### 霍夫变换参数

- **rho**: 2像素 - 距离分辨率
- **theta**: π/180弧度 - 角度分辨率
- **threshold**: 可调节 - 累加器阈值
- **min_line_len**: 可调节 - 最小线段长度
- **max_line_gap**: 可调节 - 最大间隔长度

### 控制算法

**误差计算公式**:
```
error = middle_x - miderr_x
```

其中:
- `middle_x`: 图像中心x坐标
- `miderr_x`: 左右车道线在图像底部的中点x坐标

**舵机角度转换**:
```
uart = k * err + b
k = (uart_range - 1500) / err_range
```

其中:
- `err_range`: ±80（视觉误差范围）
- `uart_range`: 1000-2000（舵机控制范围）

## 文件说明

- `Python_Nano_LKS_202302V1.py`: 主程序，实现完整的车道保持功能
- `Python_Nano_Motor_202302V2.py`: 电机控制模块
- `Python_Nano_Servo_202302V2.py`: 舵机控制模块

## 使用方法

### 运行程序

```bash
python Python_Nano_LKS_202302V1.py
```

### 参数调节

程序启动时会打开调节窗口，可实时调节以下参数：

1. **binary_value**: 二值化阈值（默认90）
2. **canny_low_threshold**: Canny边缘检测低阈值（默认68）
3. **hof_threshold**: 霍夫变换阈值（默认40）
4. **hof_min_line_len**: 最小线段长度（默认20）
5. **hof_max_line_gap**: 最大线段间隔（默认10）

### 窗口显示

- **adjust**: 参数调节窗口
- **Gray image**: 灰度图
- **Blur image**: 高斯滤波后的图像
- **Canny image**: 边缘检测结果
- **ROI image**: 感兴趣区域
- **image**: 最终结果（含车道线和FPS显示）

## 硬件要求

- **摄像头**: USB摄像头（分辨率320x240）
- **舵机**: SCServo系列舵机
- **电机**: VESC控制的无刷电机

## 控制逻辑

### 直行模式
当同时检测到左右车道线时：
- 计算车道中心线
- 计算偏差值（-40到+40）
- 根据偏差调整舵机角度

### 左转模式
当只检测到右车道线时：
- 固定误差值：-58
- 舵机左转

### 右转模式
当只检测到左车道线时：
- 固定误差值：+55
- 舵机右转

## 性能参数

- **处理帧率**: 约20-30 FPS（取决于硬件性能）
- **检测延迟**: <50ms
- **角度精度**: ±1度
- **适用场景**: 
  - 白色车道线
  - 光线良好的环境
  - 清晰的路面标线

## 注意事项

1. 确保摄像头正确安装并对准前方道路
2. 车道线需要清晰可见
3. 光线条件会影响检测效果，需根据环境调整参数
4. 建议在封闭测试场地进行调试
5. 实际使用前需充分测试和调优

## 改进方向

1. 支持曲线车道检测
2. 增加车道线类型识别（实线/虚线）
3. 添加深度学习算法提高鲁棒性
4. 优化光照适应性
5. 增加多传感器融合

## 故障排查

### 无法检测到车道线
- 检查摄像头是否正常工作
- 调整Canny阈值和霍夫变换参数
- 确认ROI区域设置是否合理

### 舵机抖动
- 增加PID控制平滑输出
- 添加误差滤波算法
- 检查舵机连接是否稳定

### 帧率过低
- 降低图像分辨率
- 优化算法性能
- 减少不必要的图像显示
